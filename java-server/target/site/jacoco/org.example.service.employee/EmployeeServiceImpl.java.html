<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="uk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmployeeServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring-boot-first-project</a> &gt; <a href="index.source.html" class="el_package">org.example.service.employee</a> &gt; <span class="el_source">EmployeeServiceImpl.java</span></div><h1>EmployeeServiceImpl.java</h1><pre class="source lang-java linenums">package org.example.service.employee;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.ZoneId;
import java.util.List;
import java.util.Optional;
import lombok.RequiredArgsConstructor;
import org.example.dto.employee.EmployeeContactDto;
import org.example.dto.employee.EmployeeUpdateRequestDto;
import org.example.dto.employee.registration.EmployeeRegistrationRequestDto;
import org.example.dto.employee.registration.EmployeeResponseDto;
import org.example.dto.page.PageResponseDto;
import org.example.exception.custom_exception.DeletionException;
import org.example.exception.custom_exception.EntityNotFoundException;
import org.example.exception.custom_exception.InvalidRoleException;
import org.example.exception.custom_exception.RegistrationException;
import org.example.mapper.employee.EmployeeMapper;
import org.example.model.employee.Role;
import org.example.model.employee.Employee;
import org.example.repository.employee.EmployeeRepository;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
<span class="fc" id="L29">@RequiredArgsConstructor</span>
public class EmployeeServiceImpl implements EmployeeService {

    private final EmployeeRepository employeeRepository;
    private final EmployeeMapper employeeMapper;
    private final PasswordEncoder passwordEncoder;

    @Override
    @Transactional
    public EmployeeResponseDto register(EmployeeRegistrationRequestDto request) throws RegistrationException {
<span class="fc bfc" id="L39" title="All 4 branches covered.">        if (request.getId_employee() == null || request.getId_employee().isEmpty()) {</span>
<span class="fc" id="L40">            throw new RegistrationException(&quot;Employee ID cannot be null or empty&quot;);</span>
        }

<span class="fc bfc" id="L43" title="All 2 branches covered.">        if (employeeRepository.existsByIdEmployee(request.getId_employee())) {</span>
<span class="fc" id="L44">            throw new RegistrationException(&quot;Employee with such ID already exists: &quot; + request.getId_employee());</span>
        }

<span class="fc" id="L47">        LocalDate birthDate = request.getDate_of_birth().toInstant()</span>
<span class="fc" id="L48">                .atZone(ZoneId.systemDefault())</span>
<span class="fc" id="L49">                .toLocalDate();</span>

<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (birthDate.isAfter(LocalDate.now().minusYears(18))) {</span>
<span class="fc" id="L52">            throw new RegistrationException(&quot;Employee must be at least 18 years old&quot;);</span>
        }

<span class="fc" id="L55">        Employee employee = employeeMapper.toEmployeeEntity(request);</span>
<span class="fc" id="L56">        employee.setId_employee(request.getId_employee());</span>
<span class="fc" id="L57">        employee.setPassword(passwordEncoder.encode(request.getPassword()));</span>

        Role.RoleName roleEnum;
        try {
<span class="fc" id="L61">            roleEnum = Role.RoleName.valueOf(request.getRole().toUpperCase().trim());</span>
<span class="fc" id="L62">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L63">            throw new InvalidRoleException(&quot;Invalid role name: &quot; + request.getRole());</span>
<span class="fc" id="L64">        }</span>

<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (employee.getSalary() == null) {</span>
<span class="fc" id="L67">            employee.setSalary(BigDecimal.ZERO);</span>
        }

<span class="fc" id="L70">        return employeeRepository.save(employee);</span>
    }

    @Override
    public PageResponseDto&lt;EmployeeResponseDto&gt; getAll(Pageable pageable,
                                                       String lastSeenSurname,
                                                       String lastSeenId) {
<span class="fc" id="L77">        return employeeRepository.findAll(pageable, lastSeenSurname, lastSeenId);</span>
    }


    @Override
    public EmployeeResponseDto updateEmployeeById(String id,
                                                  EmployeeUpdateRequestDto requestDto) {
<span class="fc" id="L84">        employeeRepository.findByIdEmployee(id).orElseThrow(</span>
<span class="fc" id="L85">                () -&gt; new EntityNotFoundException(&quot;Cannot update employee by id: &quot; + id)</span>
        );
<span class="fc" id="L87">        return employeeRepository.updateEmployeeById(id, requestDto);</span>
    }

    @Override
    public void deleteEmployeeById(String id) {
<span class="fc" id="L92">        String currentUserId = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (id.equals(currentUserId)) {</span>
<span class="fc" id="L94">            throw new DeletionException(&quot;Cannot delete yourself by your own ID: &quot; + id);</span>
        }
<span class="fc" id="L96">        employeeRepository.findByIdEmployee(id).orElseThrow(</span>
<span class="fc" id="L97">                () -&gt; new EntityNotFoundException(&quot;Cannot delete employee by id: &quot; + id)</span>
        );
<span class="fc" id="L99">        employeeRepository.deleteEmployeeById(id);</span>
<span class="fc" id="L100">    }</span>

    @Override
    public PageResponseDto&lt;EmployeeResponseDto&gt; getAllCashiers(Pageable pageable,
                                                               String lastSeenSurname,
                                                               String lastSeenId) {
<span class="fc" id="L106">        return employeeRepository.findAllCashiers(pageable, lastSeenSurname, lastSeenId);</span>
    }

    @Override
    public EmployeeResponseDto getMe() {
<span class="fc" id="L111">        String currentUserId = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc" id="L112">        Optional&lt;Employee&gt; currentUser = employeeRepository.findByIdEmployee(currentUserId);</span>
<span class="fc" id="L113">        return currentUser.map(employeeMapper::toEmployeeResponseDto)</span>
<span class="fc" id="L114">                .orElseThrow(() -&gt; new EntityNotFoundException(</span>
                &quot;Can't find authorized cashier by id: &quot; + currentUserId));
    }

    @Override
    public Optional&lt;EmployeeContactDto&gt; findPhoneAndAddressBySurname(String surname) {
<span class="fc" id="L120">        return Optional.ofNullable(employeeRepository.findPhoneAndAddressBySurname(surname)</span>
<span class="fc" id="L121">                .orElseThrow(() -&gt; new EntityNotFoundException(</span>
                        &quot;Cannot find employee by surname: &quot; + surname)));
    }

    @Override
    public List&lt;EmployeeResponseDto&gt; findAllNoPagination() {
<span class="nc" id="L127">        return employeeRepository.findAllNoPagination();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>