<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="uk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring-boot-first-project</a> &gt; <a href="index.source.html" class="el_package">org.example.repository.product</a> &gt; <span class="el_source">ProductRepository.java</span></div><h1>ProductRepository.java</h1><pre class="source lang-java linenums">package org.example.repository.product;

import lombok.RequiredArgsConstructor;
import org.example.dto.page.PageResponseDto;
import org.example.dto.product.ProductDto;
import org.example.dto.product.ProductRequestDto;
import org.example.exception.custom_exception.EntityNotFoundException;
import org.example.exception.custom_exception.InvalidCategoryException;
import org.example.mapper.product.ProductMapper;
import org.example.mapper.product.ProductRowMapper;
import org.example.model.product.Product;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.data.domain.Pageable;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;
import java.util.List;
import java.util.Optional;

<span class="fc" id="L20">@RequiredArgsConstructor</span>
@Repository
public class ProductRepository {

    private final JdbcTemplate jdbcTemplate;
    private final ProductRowMapper rowMapper;
    private final ProductMapper productMapper;

    public PageResponseDto&lt;ProductDto&gt; findAll(Pageable pageable,
                                               String lastSeenName,
                                               Integer lastSeenId) {
        List&lt;ProductDto&gt; products;
<span class="pc bpc" id="L32" title="2 of 6 branches missed.">        if (lastSeenName != null &amp;&amp; lastSeenId != null &amp;&amp; lastSeenId &gt; 0) {</span>
<span class="fc" id="L33">            products = jdbcTemplate.query(</span>
                            &quot;&quot;&quot;
                                 SELECT *
                                 FROM product
                                 WHERE (product_name &gt; ?)
                                    OR (product_name = ? AND id_product &gt; ?)
                                 ORDER BY product_name, id_product
                                 FETCH FIRST ? ROWS ONLY
                                 &quot;&quot;&quot;,
                            rowMapper,
                            lastSeenName,
                            lastSeenName,
                            lastSeenId,
<span class="fc" id="L46">                            pageable.getPageSize()</span>
<span class="fc" id="L47">                    ).stream()</span>
<span class="fc" id="L48">                    .map(productMapper::toDto)</span>
<span class="fc" id="L49">                    .toList();</span>
        } else {
<span class="fc" id="L51">            int pageNumber = pageable.getPageNumber();</span>
<span class="fc" id="L52">            int pageSize = pageable.getPageSize();</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">            if (pageNumber == 0) {</span>
<span class="fc" id="L54">                products = jdbcTemplate.query(</span>
                                &quot;&quot;&quot;
                                    SELECT *
                                    FROM product
                                    ORDER BY product_name, id_product
                                    FETCH FIRST ? ROWS ONLY
                                    &quot;&quot;&quot;,
                                rowMapper,
<span class="fc" id="L62">                                pageSize</span>
<span class="fc" id="L63">                        ).stream()</span>
<span class="fc" id="L64">                        .map(productMapper::toDto)</span>
<span class="fc" id="L65">                        .toList();</span>
            } else {
<span class="fc" id="L67">                int totalToFetch = (pageNumber + 1) * pageSize;</span>
<span class="fc" id="L68">                List&lt;Product&gt; allProducts = jdbcTemplate.query(</span>
                        &quot;&quot;&quot;
                            SELECT *
                            FROM product
                            ORDER BY product_name, id_product
                            FETCH FIRST ? ROWS ONLY
                            &quot;&quot;&quot;,
                        rowMapper,
<span class="fc" id="L76">                        totalToFetch</span>
                );

<span class="fc" id="L79">                int startIndex = pageNumber * pageSize;</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">                if (startIndex &lt; allProducts.size()) {</span>
<span class="fc" id="L81">                    products = allProducts.subList(startIndex, allProducts.size())</span>
<span class="fc" id="L82">                            .stream()</span>
<span class="fc" id="L83">                            .map(productMapper::toDto)</span>
<span class="fc" id="L84">                            .toList();</span>
                } else {
<span class="nc" id="L86">                    products = List.of();</span>
                }
            }
        }

<span class="fc" id="L91">        long total = getTotalCount();</span>
<span class="fc" id="L92">        return PageResponseDto.of(</span>
                products,
<span class="fc" id="L94">                pageable.getPageNumber(),</span>
<span class="fc" id="L95">                pageable.getPageSize(),</span>
                total
        );
    }

    public PageResponseDto&lt;ProductDto&gt; findByName(String name,
                                                  Pageable pageable,
                                                  String lastSeenName,
                                                  Integer lastSeenId) {
        List&lt;ProductDto&gt; products;

<span class="pc bpc" id="L106" title="2 of 6 branches missed.">        if (lastSeenName != null &amp;&amp; lastSeenId != null &amp;&amp; lastSeenId &gt; 0) {</span>
<span class="fc" id="L107">            products = jdbcTemplate.query(</span>
                            &quot;&quot;&quot;
                                 SELECT *
                                 FROM product
                                 WHERE product_name = ?
                                   AND id_product &gt; ?
                                 ORDER BY product_name, id_product
                                 FETCH FIRST ? ROWS ONLY
                                 &quot;&quot;&quot;,
                            rowMapper,
                            name,
                            lastSeenId,
<span class="fc" id="L119">                            pageable.getPageSize()</span>
<span class="fc" id="L120">                    ).stream()</span>
<span class="fc" id="L121">                    .map(productMapper::toDto)</span>
<span class="fc" id="L122">                    .toList();</span>
        } else {
<span class="fc" id="L124">            int pageNumber = pageable.getPageNumber();</span>
<span class="fc" id="L125">            int pageSize = pageable.getPageSize();</span>

<span class="pc bpc" id="L127" title="1 of 2 branches missed.">            if (pageNumber == 0) {</span>
<span class="fc" id="L128">                products = jdbcTemplate.query(</span>
                                &quot;&quot;&quot;
                                    SELECT *
                                    FROM product
                                    WHERE product_name = ?
                                    ORDER BY product_name, id_product
                                    FETCH FIRST ? ROWS ONLY
                                    &quot;&quot;&quot;,
                                rowMapper,
                                name,
<span class="fc" id="L138">                                pageSize</span>
<span class="fc" id="L139">                        ).stream()</span>
<span class="fc" id="L140">                        .map(productMapper::toDto)</span>
<span class="fc" id="L141">                        .toList();</span>
            } else {
<span class="nc" id="L143">                int totalToFetch = (pageNumber + 1) * pageSize;</span>

<span class="nc" id="L145">                List&lt;Product&gt; allProducts = jdbcTemplate.query(</span>
                        &quot;&quot;&quot;
                            SELECT *
                            FROM product
                            WHERE product_name = ?
                            ORDER BY product_name, id_product
                            FETCH FIRST ? ROWS ONLY
                            &quot;&quot;&quot;,
                        rowMapper,
                        name,
<span class="nc" id="L155">                        totalToFetch</span>
                );

<span class="nc" id="L158">                int startIndex = pageNumber * pageSize;</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                if (startIndex &lt; allProducts.size()) {</span>
<span class="nc" id="L160">                    products = allProducts.subList(startIndex, allProducts.size())</span>
<span class="nc" id="L161">                            .stream()</span>
<span class="nc" id="L162">                            .map(productMapper::toDto)</span>
<span class="nc" id="L163">                            .toList();</span>
                } else {
<span class="nc" id="L165">                    products = List.of();</span>
                }
            }
        }

<span class="fc" id="L170">        long total = getNameCount(name);</span>
<span class="fc" id="L171">        return PageResponseDto.of(</span>
                products,
<span class="fc" id="L173">                pageable.getPageNumber(),</span>
<span class="fc" id="L174">                pageable.getPageSize(),</span>
                total
        );
    }

    public PageResponseDto&lt;ProductDto&gt; findByCategoryId(int category_number,
                                                        Pageable pageable,
                                                        String lastSeenName,
                                                        Integer lastSeenId) {
        List&lt;ProductDto&gt; products;

<span class="pc bpc" id="L185" title="2 of 6 branches missed.">        if (lastSeenName != null &amp;&amp; lastSeenId != null &amp;&amp; lastSeenId &gt; 0) {</span>
<span class="fc" id="L186">            products = jdbcTemplate.query(</span>
                            &quot;&quot;&quot;
                                 SELECT *
                                 FROM product
                                 WHERE category_number = ?
                                   AND ((product_name &gt; ?)
                                    OR (product_name = ? AND id_product &gt; ?))
                                 ORDER BY product_name, id_product
                                 FETCH FIRST ? ROWS ONLY
                                 &quot;&quot;&quot;,
                            rowMapper,
<span class="fc" id="L197">                            category_number,</span>
                            lastSeenName,
                            lastSeenName,
                            lastSeenId,
<span class="fc" id="L201">                            pageable.getPageSize()</span>
<span class="fc" id="L202">                    ).stream()</span>
<span class="fc" id="L203">                    .map(productMapper::toDto)</span>
<span class="fc" id="L204">                    .toList();</span>
        } else {
<span class="fc" id="L206">            int pageNumber = pageable.getPageNumber();</span>
<span class="fc" id="L207">            int pageSize = pageable.getPageSize();</span>

<span class="pc bpc" id="L209" title="1 of 2 branches missed.">            if (pageNumber == 0) {</span>
<span class="fc" id="L210">                products = jdbcTemplate.query(</span>
                                &quot;&quot;&quot;
                                    SELECT *
                                    FROM product
                                    WHERE category_number = ?
                                    ORDER BY product_name, id_product
                                    FETCH FIRST ? ROWS ONLY
                                    &quot;&quot;&quot;,
                                rowMapper,
<span class="fc" id="L219">                                category_number,</span>
<span class="fc" id="L220">                                pageSize</span>
<span class="fc" id="L221">                        ).stream()</span>
<span class="fc" id="L222">                        .map(productMapper::toDto)</span>
<span class="fc" id="L223">                        .toList();</span>
            } else {
<span class="nc" id="L225">                int totalToFetch = (pageNumber + 1) * pageSize;</span>

<span class="nc" id="L227">                List&lt;Product&gt; allProducts = jdbcTemplate.query(</span>
                        &quot;&quot;&quot;
                            SELECT *
                            FROM product
                            WHERE category_number = ?
                            ORDER BY product_name, id_product
                            FETCH FIRST ? ROWS ONLY
                            &quot;&quot;&quot;,
                        rowMapper,
<span class="nc" id="L236">                        category_number,</span>
<span class="nc" id="L237">                        totalToFetch</span>
                );

<span class="nc" id="L240">                int startIndex = pageNumber * pageSize;</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                if (startIndex &lt; allProducts.size()) {</span>
<span class="nc" id="L242">                    products = allProducts.subList(startIndex, allProducts.size())</span>
<span class="nc" id="L243">                            .stream()</span>
<span class="nc" id="L244">                            .map(productMapper::toDto)</span>
<span class="nc" id="L245">                            .toList();</span>
                } else {
<span class="nc" id="L247">                    products = List.of();</span>
                }
            }
        }

<span class="fc" id="L252">        long total = getCategoryIdCount(category_number);</span>
<span class="fc" id="L253">        return PageResponseDto.of(</span>
                products,
<span class="fc" id="L255">                pageable.getPageNumber(),</span>
<span class="fc" id="L256">                pageable.getPageSize(),</span>
                total
        );
    }

    public Optional&lt;Product&gt; findById(int id) {
        try {
<span class="fc" id="L263">            return Optional.ofNullable(</span>
<span class="fc" id="L264">                    jdbcTemplate.queryForObject(</span>
                            &quot;&quot;&quot;
                            SELECT *
                            FROM product
                            WHERE id_product = ?
                            &quot;&quot;&quot;,
                            rowMapper,
<span class="fc" id="L271">                            id</span>
                    )
            );
<span class="fc" id="L274">        } catch (EmptyResultDataAccessException e) {</span>
<span class="fc" id="L275">            return Optional.empty();</span>
        }
    }

    public Product save(Product product) {
        try {
<span class="fc bfc" id="L281" title="All 2 branches covered.">            if (product.getId_product() == 0) {</span>
<span class="fc" id="L282">                return jdbcTemplate.queryForObject(</span>
                        &quot;&quot;&quot;
                        INSERT INTO product (
                            product_name,
                            product_characteristics,
                            category_number
                        ) VALUES (?, ?, ?)
                        RETURNING *
                        &quot;&quot;&quot;,
                        rowMapper,
<span class="fc" id="L292">                        product.getProduct_name(),</span>
<span class="fc" id="L293">                        product.getProduct_characteristics(),</span>
<span class="fc" id="L294">                        product.getCategory_number()</span>
                );
            } else {
<span class="fc" id="L297">                int updated = jdbcTemplate.update(</span>
                        &quot;&quot;&quot;
                        UPDATE product SET
                            product_name = ?,
                            product_characteristics = ?,
                            category_number = ?
                        WHERE id_product = ?
                        &quot;&quot;&quot;,
<span class="fc" id="L305">                        product.getProduct_name(),</span>
<span class="fc" id="L306">                        product.getProduct_characteristics(),</span>
<span class="fc" id="L307">                        product.getCategory_number(),</span>
<span class="fc" id="L308">                        product.getId_product()</span>
                );

<span class="fc bfc" id="L311" title="All 2 branches covered.">                if (updated == 0) {</span>
<span class="fc" id="L312">                    throw new EntityNotFoundException(&quot;Product not found: &quot; + product.getId_product());</span>
                }

<span class="fc" id="L315">                return findById(product.getId_product())</span>
<span class="pc" id="L316">                        .orElseThrow(() -&gt; new EntityNotFoundException(</span>
<span class="nc" id="L317">                                &quot;Product not found after update: &quot; + product.getId_product()));</span>
            }
<span class="fc" id="L319">        } catch (DataIntegrityViolationException e) {</span>
<span class="fc" id="L320">            throw new InvalidCategoryException(&quot;Invalid category: &quot;</span>
<span class="fc" id="L321">                    + product.getCategory_number());</span>
        }
    }

    public ProductDto updateProductById(int id, ProductRequestDto requestDto) {
<span class="fc bfc" id="L326" title="All 2 branches covered.">        if (!existsByIdProduct(id)) {</span>
<span class="fc" id="L327">            throw new EntityNotFoundException(&quot;Product not found: &quot; + id);</span>
        }

        try {
<span class="fc" id="L331">            int updatedRows = jdbcTemplate.update(</span>
                    &quot;&quot;&quot;
                    UPDATE product SET
                        product_name = ?,
                        product_characteristics = ?,
                        category_number = ?
                    WHERE id_product = ?
                    &quot;&quot;&quot;,
<span class="fc" id="L339">                    requestDto.getProduct_name(),</span>
<span class="fc" id="L340">                    requestDto.getProduct_characteristics(),</span>
<span class="fc" id="L341">                    requestDto.getCategory_number(),</span>
<span class="fc" id="L342">                    id</span>
            );

<span class="pc bpc" id="L345" title="1 of 2 branches missed.">            if (updatedRows == 0) {</span>
<span class="nc" id="L346">                throw new EntityNotFoundException(&quot;Update failed, product not found: &quot; + id);</span>
            }

<span class="fc" id="L349">            return findById(id)</span>
<span class="fc" id="L350">                    .map(productMapper::toDto)</span>
<span class="pc" id="L351">                    .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Product not found after update: &quot; + id));</span>

<span class="fc" id="L353">        } catch (DataIntegrityViolationException e) {</span>
<span class="fc" id="L354">            throw new InvalidCategoryException(&quot;Invalid category: &quot; + requestDto.getCategory_number());</span>
        }
    }

    public void deleteById(int id) {
<span class="fc bfc" id="L359" title="All 2 branches covered.">        if (!existsByIdProduct(id)) {</span>
<span class="fc" id="L360">            throw new EntityNotFoundException(&quot;Product not found: &quot; + id);</span>
        }
<span class="fc" id="L362">        jdbcTemplate.update(&quot;&quot;&quot;</span>
                        DELETE
                        FROM product
                        WHERE id_product = ?
<span class="fc" id="L366">                        &quot;&quot;&quot;, id);</span>
<span class="fc" id="L367">    }</span>

    public boolean existsByIdProduct(int idProduct) {
<span class="fc" id="L370">        Integer count = jdbcTemplate.queryForObject(</span>
                &quot;&quot;&quot;
                SELECT COUNT(*)
                FROM product
                WHERE id_product = ?
                &quot;&quot;&quot;,
                Integer.class,
<span class="fc" id="L377">                idProduct</span>
        );
<span class="pc bpc" id="L379" title="1 of 4 branches missed.">        return count != null &amp;&amp; count &gt; 0;</span>
    }

    public List&lt;ProductDto&gt; findAllNoPagination() {
<span class="fc" id="L383">        return jdbcTemplate.query(&quot;&quot;&quot;</span>
                            SELECT *
                            FROM product
                            ORDER BY product_name
                            &quot;&quot;&quot;,
                        rowMapper)
<span class="fc" id="L389">                .stream()</span>
<span class="fc" id="L390">                .map(productMapper::toDto)</span>
<span class="fc" id="L391">                .toList();</span>
    }

    private long getTotalCount() {
<span class="fc" id="L395">        Integer count = jdbcTemplate.queryForObject(</span>
                &quot;&quot;&quot;
                SELECT COUNT(*)
                FROM product&quot;&quot;&quot;,
                Integer.class
        );
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">        return count != null ? count : 0;</span>
    }

    private long getNameCount(String name) {
<span class="fc" id="L405">        Integer count = jdbcTemplate.queryForObject(</span>
                &quot;&quot;&quot;
                SELECT COUNT(*)
                FROM product
                WHERE product_name = ?
                &quot;&quot;&quot;,
                Integer.class,
                name
        );
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">        return count != null ? count : 0;</span>
    }

    private long getCategoryIdCount(int category_number) {
<span class="fc" id="L418">        Integer count = jdbcTemplate.queryForObject(</span>
                &quot;&quot;&quot;
                SELECT COUNT(*)
                FROM product
                WHERE category_number = ?
                &quot;&quot;&quot;,
                Integer.class,
<span class="fc" id="L425">                category_number</span>
        );
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">        return count != null ? count : 0;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>